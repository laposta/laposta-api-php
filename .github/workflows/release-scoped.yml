name: Build Scoped Release

on:
    release:
        types: [published]
    workflow_dispatch:

jobs:
    scoped-release:
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: '8.1'
                  extensions: curl, json
                  composer-cache: true

            - name: Install dependencies
              run: composer install --prefer-dist --no-progress

            - name: Build scoped distribution
              run: composer build:scoped

            - name: Smoke test scoped build
              run: bash scripts/test-scoped.sh

            - name: Package scoped archive
              run: |
                  ZIP_NAME="laposta-api-scoped.zip"
                  cd build/scoped
                  zip -r "../${ZIP_NAME}" .

            - name: Upload release asset
              if: github.event_name == 'release'
              uses: softprops/action-gh-release@v2
              with:
                  files: build/laposta-api-scoped.zip
